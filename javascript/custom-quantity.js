/**
 * Custom quantity input functionality for WooCommerce.
 *
 * This script adds increment/decrement buttons to the quantity input field
 * and handles their functionality, ensuring compatibility with WooCommerce.
 */
export function initializeQuantityButtons() {
    // Select all quantity button wrappers that were generated by our PHP filter.
    const quantityWrappers = document.querySelectorAll('.ghost-quantity-buttons');

    quantityWrappers.forEach(wrapper => {
        const minusButton = wrapper.querySelector('.ghost-qty-minus');
        const plusButton = wrapper.querySelector('.ghost-qty-plus');
        const qtyInput = wrapper.querySelector('input.qty');

        if (!minusButton || !plusButton || !qtyInput) {
            return; // Skip if elements are not found
        }

        const min = parseFloat(qtyInput.getAttribute('min')) || 0;
        const max = parseFloat(qtyInput.getAttribute('max')) || 9999; // Default large max
        const step = parseFloat(qtyInput.getAttribute('step')) || 1;

        // Function to update quantity
        const updateQuantity = (change) => {
            let currentVal = parseFloat(qtyInput.value);
            if (isNaN(currentVal)) {
                currentVal = 0; // Default to 0 if not a number
            }

            let newVal = currentVal + change;

            // Enforce min and max values
            if (newVal < min) {
                newVal = min;
            } else if (newVal > max) {
                newVal = max;
            }

            if (newVal !== currentVal) {
                qtyInput.value = newVal;
                // Trigger change event so WooCommerce (and other scripts) can react
                qtyInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
        };

        // Event listener for minus button
        minusButton.addEventListener('click', (e) => {
            e.preventDefault(); // Prevent default button action
            updateQuantity(-step);
        });

        // Event listener for plus button
        plusButton.addEventListener('click', (e) => {
            e.preventDefault(); // Prevent default button action
            updateQuantity(step);
        });

        // Add event listener for when the quantity input itself changes
        // This is important if user types directly into the input
        qtyInput.addEventListener('change', () => {
            let currentVal = parseFloat(qtyInput.value);
            if (isNaN(currentVal)) {
                currentVal = min; // Reset to min if invalid
            }

            // Ensure value is within min/max bounds after manual input
            if (currentVal < min) {
                currentVal = min;
            } else if (currentVal > max) {
                currentVal = max;
            }

            if (parseFloat(qtyInput.value) !== currentVal) {
                qtyInput.value = currentVal;
                qtyInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });
    });
}
